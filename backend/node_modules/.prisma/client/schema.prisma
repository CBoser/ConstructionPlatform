// MindFlow Platform - Database Schema
// Foundation Layer: Core business data with variance tracking hooks

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash") // Bcrypt hashed password
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  role         UserRole @default(ESTIMATOR)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  createdJobs      Job[]            @relation("JobCreator")
  approvedJobs     Job[]            @relation("JobApprover")
  auditLogs        AuditLog[]
  notifications    Notification[]
  varianceReviews  VarianceReview[]
  activityLogs     ActivityLog[]
  pdssPlanAssigned PDSSPlanStatus[] // PDSS plans assigned to this user
  pdssJobAssigned  PDSSJobStatus[] // PDSS jobs assigned to this user

  // Feedback relations
  feedbackSubmitted Feedback[]         @relation("FeedbackSubmitter")
  feedbackResolved  Feedback[]         @relation("FeedbackResolver")
  feedbackResponses FeedbackResponse[]

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  ADMIN
  ESTIMATOR
  PROJECT_MANAGER
  FIELD_USER
  VIEWER
}

// ============================================================================
// FOUNDATION LAYER: CUSTOMERS
// ============================================================================

model Customer {
  id               String       @id @default(uuid())
  customerName     String       @map("customer_name")
  customerType     CustomerType @map("customer_type")
  pricingTier      String?      @map("pricing_tier") // Legacy field, superseded by pricingTiers relation
  primaryContactId String?      @map("primary_contact_id")
  isActive         Boolean      @default(true) @map("is_active")
  notes            String?
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // BAT System Integration Fields
  billToId        String? @unique @map("bill_to_id") // Primary BAT identifier (e.g., 655352)
  customerId      String? @unique @map("customer_id_bat") // Secondary ERP ID (e.g., 662662)
  salesId         String? @map("sales_id") // Salesperson ID (e.g., P761647)
  salespersonName String? @map("salesperson_name") // e.g., "COREY BOSER"
  locationCode    String? @map("location_code") // e.g., CLACORAD, FOGRORYD
  accountType     String? @map("account_type") // M (Master), Q (Quote)

  // Relationships
  contacts            CustomerContact[]
  pricingTiers        CustomerPricingTier[]
  externalIds         CustomerExternalId[]
  jobs                Job[]
  communities         Community[]
  plans               Plan[] // Plans owned by this builder
  customerPricing     CustomerPricing[]
  variancePatterns    VariancePattern[]
  portalOrders        PortalOrder[]
  portalDocuments     PortalDocument[]
  systemAlerts        SystemAlert[]
  activityLogs        ActivityLog[]
  pdssDocRequirements PDSSDocumentRequirement[]

  @@index([billToId])
  @@index([locationCode])
  @@map("customers")
}

enum CustomerType {
  PRODUCTION
  SEMI_CUSTOM
  FULL_CUSTOM
}

model CustomerContact {
  id                    String   @id @default(uuid())
  customerId            String   @map("customer_id")
  contactName           String   @map("contact_name")
  role                  String?
  email                 String?
  phone                 String?
  receivesNotifications Boolean  @default(true) @map("receives_notifications")
  isPrimary             Boolean  @default(false) @map("is_primary")
  createdAt             DateTime @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_contacts")
}

model CustomerPricingTier {
  id         String @id @default(uuid())
  customerId String @map("customer_id")

  // DART Category-Based Tiering (BAT System)
  dartCategory     Int    @default(1) @map("dart_category") // 1-15 (see DartCategory enum for mapping)
  dartCategoryName String @default("01-Lumber") @map("dart_category_name") // e.g., "01-Lumber", "02-StrctP"
  tier             String @default("01") @map("tier") // "01"-"12" or "L5" (Random Lengths)

  // Legacy discount-based pricing (optional)
  tierName           String?  @map("tier_name")
  discountPercentage Decimal? @map("discount_percentage") @db.Decimal(5, 2)

  effectiveDate  DateTime  @map("effective_date")
  expirationDate DateTime? @map("expiration_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, dartCategory, effectiveDate])
  @@index([customerId])
  @@index([dartCategory])
  @@map("customer_pricing_tiers")
}

model CustomerExternalId {
  id                   String   @id @default(uuid())
  customerId           String   @map("customer_id")
  externalSystem       String   @map("external_system")
  externalCustomerId   String   @map("external_customer_id")
  externalCustomerName String?  @map("external_customer_name")
  isPrimary            Boolean  @default(false) @map("is_primary")
  createdAt            DateTime @default(now()) @map("created_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, externalSystem])
  @@map("customer_external_ids")
}

// Customer-specific pricing overrides
model CustomerPricing {
  id         String @id @default(uuid())
  customerId String
  materialId String

  // Override pricing
  overridePrice      Decimal? @db.Decimal(10, 2)
  overrideMargin     Decimal? @db.Decimal(5, 2)
  discountPercentage Decimal? @db.Decimal(5, 2)

  effectiveDate DateTime  @default(now())
  expiresAt     DateTime?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([customerId, materialId])
  @@index([customerId])
  @@index([materialId])
}

// ============================================================================
// FOUNDATION LAYER: PLANS
// ============================================================================

model Plan {
  id               String  @id @default(uuid())
  code             String  @unique // e.g., "2400", "G21D"
  name             String? // Human-readable name
  customerPlanCode String? @map("customer_plan_code") // Customer's plan code if different from our code

  // Builder/Customer ownership
  builderId String? @map("builder_id") // Which builder owns this plan

  // Plan Characteristics
  type      PlanType
  sqft      Int?
  bedrooms  Int?
  bathrooms Decimal? @db.Decimal(3, 1)
  garage    String? // "2-Car", "3-Car", etc.
  style     String? // "Ranch", "Modern", etc.

  // Version Control
  version  Int     @default(1)
  isActive Boolean @default(true)

  // Documentation
  pdssUrl String? // Plan Design & Specification Sheet URL
  notes   String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  builder          Customer?            @relation(fields: [builderId], references: [id])
  elevations       PlanElevation[]
  options          PlanOption[]
  assignedOptions  PlanAssignedOption[] // Options assigned to this plan
  templateItems    PlanTemplateItem[] // BOM template
  jobs             Job[]
  variancePatterns VariancePattern[]
  documents        PlanDocument[] // Uploaded documents
  portalDocuments  PortalDocument[] // Documents synced from portals
  pdssStatus       PDSSPlanStatus[] // PDSS tracking for this plan

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([builderId])
}

enum PlanType {
  SINGLE_STORY
  TWO_STORY
  THREE_STORY
  DUPLEX
  TOWNHOME
}

model PlanElevation {
  id          String  @id @default(uuid())
  planId      String
  code        String // "A", "B", "C", "D"
  name        String? // "Craftsman", "Contemporary"
  description String?
  imageUrl    String?

  // Vendor/Designer Information
  architectDesigner      String?
  architectDesignerDate  DateTime?
  structuralEngineer     String?
  structuralEngineerDate DateTime?
  iJoistCompany          String?
  iJoistCompanyDate      DateTime?
  floorTrussCompany      String?
  floorTrussCompanyDate  DateTime?
  roofTrussCompany       String?
  roofTrussCompanyDate   DateTime?

  // Custom details (JSON array for flexibility)
  customDetails Json? // [{ "label": "Other", "value": "...", "date": "..." }]

  // Current version number
  currentVersion Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plan            Plan                 @relation(fields: [planId], references: [id], onDelete: Cascade)
  jobs            Job[]
  versionHistory  ElevationVersion[]
  assignedOptions PlanAssignedOption[] // Options specific to this elevation
  documents       PlanDocument[] // Uploaded documents specific to this elevation
  pdssStatus      PDSSPlanStatus[] // PDSS tracking for this elevation

  @@unique([planId, code])
  @@index([planId])
}

// Version history for elevation plan changes
model ElevationVersion {
  id          String  @id @default(uuid())
  elevationId String
  version     Int
  changeNotes String? // Description of what changed
  changedBy   String? // Who made the change

  // Snapshot of vendor info at this version
  architectDesigner      String?
  architectDesignerDate  DateTime?
  structuralEngineer     String?
  structuralEngineerDate DateTime?
  iJoistCompany          String?
  iJoistCompanyDate      DateTime?
  floorTrussCompany      String?
  floorTrussCompanyDate  DateTime?
  roofTrussCompany       String?
  roofTrussCompanyDate   DateTime?
  customDetails          Json?

  createdAt DateTime @default(now())

  elevation PlanElevation @relation(fields: [elevationId], references: [id], onDelete: Cascade)

  @@unique([elevationId, version])
  @@index([elevationId])
}

model PlanOption {
  id          String         @id @default(uuid())
  code        String         @unique // "DECK-12X12", "SUNROOM"
  name        String
  description String?
  category    OptionCategory

  // Pricing
  basePrice Decimal @db.Decimal(10, 2)

  // Pack Triggers
  triggersPacks String[] // Array of pack names this option triggers

  // Applicability
  appliesTo String[] // Array of plan codes (empty = all plans)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  plans      Plan[]
  jobOptions JobOption[]

  @@index([code])
  @@index([category])
}

// Plan-specific options (assigned options to a specific plan or elevation)
model PlanAssignedOption {
  id          String  @id @default(uuid())
  planId      String  @map("plan_id")
  elevationId String? @map("elevation_id") // null = plan-level, set = elevation-specific

  name        String // Option name (e.g., "Extended Deck", "Sunroom Addition")
  description String? // Additional details
  category    OptionCategory @default(OTHER)

  // Pricing (optional - may not apply)
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(10, 2)

  // Additional metadata
  notes      String? @db.Text
  isStandard Boolean @default(false) @map("is_standard") // Standard option vs upgrade

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  plan      Plan           @relation(fields: [planId], references: [id], onDelete: Cascade)
  elevation PlanElevation? @relation(fields: [elevationId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([elevationId])
  @@index([category])
}

enum OptionCategory {
  DECK
  FENCING
  ROOM_ADDITION
  GARAGE
  PATIO
  STRUCTURAL
  FINISH
  OTHER
}

// Plan Documents - File uploads for plans and elevations
model PlanDocument {
  id String @id @default(uuid())

  // Association (either plan-level or elevation-specific)
  planId      String  @map("plan_id")
  elevationId String? @map("elevation_id") // null = plan-level, set = elevation-specific

  // File metadata
  fileName String       @map("file_name")
  fileType DocumentType @map("file_type")
  filePath String       @map("file_path") // Storage path
  fileSize Int          @map("file_size") // Size in bytes
  mimeType String       @map("mime_type")

  // Version control
  version      Int      @default(1)
  documentDate DateTime @map("document_date") // User-specified date for the document

  // Archive tracking
  isArchived   Boolean   @default(false) @map("is_archived")
  archiveDate  DateTime? @map("archive_date")
  archiveNotes String?   @map("archive_notes") @db.Text

  // Version comparison
  changeNotes  String?        @map("change_notes") @db.Text // Notes on what changed in this version
  replacedById String?        @map("replaced_by_id") // Points to the document that replaced this one
  replacedBy   PlanDocument?  @relation("DocumentReplacement", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces     PlanDocument[] @relation("DocumentReplacement")

  // Metadata
  uploadedBy String? @map("uploaded_by") // User email or ID

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  plan      Plan           @relation(fields: [planId], references: [id], onDelete: Cascade)
  elevation PlanElevation? @relation(fields: [elevationId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([elevationId])
  @@index([fileType])
  @@index([isArchived])
  @@index([documentDate])
  @@map("plan_documents")
}

enum DocumentType {
  PLAN_DRAWING // Plan drawings/blueprints
  ELEVATION_DRAWING // Elevation-specific drawings
  SPECIFICATIONS // Plan specifications
  MATERIAL_LIST // Material/BOM lists
  PRICING_SHEET // Pricing information
  OPTION_DETAILS // Option details and pricing
  OTHER // Other document types
}

// Plan Template - The "recipe" for a plan
model PlanTemplateItem {
  id         String @id @default(uuid())
  planId     String
  materialId String

  // Quantities
  quantity    Decimal @db.Decimal(10, 3)
  unit        String
  wasteFactor Decimal @default(0) @db.Decimal(5, 2) // Percentage

  // Categorization
  category    String // "Framing", "Roof", "Foundation"
  subcategory String?

  // Variance Tracking (for feedback loop)
  averageVariance  Decimal?  @db.Decimal(5, 2) // Historical avg variance %
  varianceCount    Int       @default(0) // Number of jobs sampled
  lastVarianceDate DateTime? // Last time variance was recorded
  confidenceScore  Decimal?  @db.Decimal(3, 2) // 0-1 confidence in template accuracy

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plan     Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@unique([planId, materialId])
  @@index([planId])
  @@index([materialId])
  @@index([category])
}

// ============================================================================
// FOUNDATION LAYER: MATERIALS & PRICING
// ============================================================================

model Material {
  id          String @id @default(uuid())
  sku         String @unique
  description String

  // Categorization
  category    MaterialCategory
  subcategory String?

  // DART Category (BAT System Pricing)
  dartCategory     Int?    @map("dart_category") // 1-15 for tier-based pricing lookup
  dartCategoryName String? @map("dart_category_name") // e.g., "01-Lumber", "special"

  // Unit of Measure
  unitOfMeasure String // "EA", "LF", "SF", "MBF", "SHT"

  // Base Costs
  vendorCost Decimal @db.Decimal(10, 2)
  freight    Decimal @default(0) @db.Decimal(10, 2)

  // Commodity Pricing (for lumber)
  isRLLinked    Boolean   @default(false) // Linked to Random Lengths
  rlTag         String? // Random Lengths commodity tag
  rlBasePrice   Decimal?  @db.Decimal(10, 2)
  rlLastUpdated DateTime?

  // Length Modifiers (for lumber)
  lengthAdders     Json? // { "8": 0, "10": 0.15, "12": 0.25 }
  gradeMultipliers Json? // { "SPF": 1.0, "SYP": 1.15 }

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  vendor           Vendor?            @relation(fields: [vendorId], references: [id])
  vendorId         String?
  pricingHistory   PricingHistory[]
  priceRevisions   PriceRevision[]
  templateItems    PlanTemplateItem[]
  customerPricing  CustomerPricing[]
  takeoffLineItems TakeoffLineItem[]

  @@index([sku])
  @@index([category])
  @@index([dartCategory])
  @@index([isActive])
  @@index([isRLLinked])
}

enum MaterialCategory {
  DIMENSIONAL_LUMBER
  ENGINEERED_LUMBER
  SHEATHING
  PRESSURE_TREATED
  HARDWARE
  CONCRETE
  ROOFING
  SIDING
  INSULATION
  DRYWALL
  OTHER
}

model Vendor {
  id   String @id @default(uuid())
  name String
  code String @unique

  // Contact
  primaryContact String?
  email          String?
  phone          String?

  // Terms
  paymentTerms String? // "Net 30", "Net 45"
  leadTimeDays Int     @default(5)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  materials      Material[]
  purchaseOrders PurchaseOrder[]

  @@index([code])
}

// Transparent Pricing Pipeline - Shows calculation breakdown
model PricingHistory {
  id         String @id @default(uuid())
  materialId String

  // Pricing Breakdown (Transparent Calculation)
  baseVendorCost      Decimal @db.Decimal(10, 2)
  commodityAdjustment Decimal @default(0) @db.Decimal(10, 2)
  freight             Decimal @default(0) @db.Decimal(10, 2)
  totalCost           Decimal @db.Decimal(10, 2)

  // Margin
  marginPercentage Decimal @db.Decimal(5, 2)
  marginAmount     Decimal @db.Decimal(10, 2)

  // Final Price
  unitPrice Decimal @db.Decimal(10, 2)

  // Calculation Steps (for pedagogical transparency)
  calculationSteps Json // Array of calculation step objects

  effectiveDate DateTime  @default(now())
  expiresAt     DateTime?

  createdAt DateTime @default(now())

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([effectiveDate])
}

// Random Lengths Commodity Pricing
model RandomLengthsPricing {
  id          String @id @default(uuid())
  tag         String // Commodity tag
  description String

  // Pricing
  price Decimal @db.Decimal(10, 2)
  unit  String // "MBF", "MSF"

  // Metadata
  region String?
  grade  String?

  effectiveDate DateTime
  source        String // "RL_REPORT_2024_12_01"

  createdAt DateTime @default(now())

  @@unique([tag, effectiveDate])
  @@index([tag])
  @@index([effectiveDate])
}

// Price Revision Tracking - Audit trail for all price changes
model PriceRevision {
  id         String @id @default(uuid())
  materialId String @map("material_id")

  // Revision Details
  revisionNumber Int    @map("revision_number") // Sequential revision number per material
  revisionType   String @map("revision_type") // "INITIAL", "COST_CHANGE", "MARGIN_ADJUST", "COMMODITY_UPDATE", "TIER_CHANGE"

  // Price Data (All tiers PL01-PL12)
  tierPrices Json // { "01": 10.50, "02": 9.75, ... "12": 7.25, "L5": "RL_CALC" }

  // Cost Breakdown
  vendorCost      Decimal  @db.Decimal(10, 2)
  freight         Decimal  @default(0) @db.Decimal(10, 2)
  commodityFactor Decimal? @db.Decimal(5, 4) // Commodity price multiplier
  baseMargin      Decimal  @db.Decimal(5, 2) // Base margin %

  // Effective Dates
  effectiveDate DateTime  @map("effective_date")
  expiresAt     DateTime? @map("expires_at")

  // Change Tracking
  changedBy    String? @map("changed_by") // User ID or "SYSTEM"
  changeReason String? @map("change_reason") // Reason for price change
  notes        String? @db.Text

  // BAT Import Tracking
  batImportDate DateTime? @map("bat_import_date")
  batFileName   String?   @map("bat_file_name")

  createdAt DateTime @default(now()) @map("created_at")

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, revisionNumber])
  @@index([materialId])
  @@index([effectiveDate])
  @@index([revisionType])
  @@map("price_revisions")
}

// ============================================================================
// OPERATIONAL CORE: COMMUNITIES & LOTS
// ============================================================================

model Community {
  id         String @id @default(uuid())
  name       String
  customerId String

  // Location
  shippingYard String
  jurisdiction String?
  region       String?

  // Status
  activePlans Int     @default(0)
  isActive    Boolean @default(true)

  // Requirements
  specialRequirements String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer          Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lots              Lot[]
  jobs              Job[]
  variancePatterns  VariancePattern[]
  portalOrders      PortalOrder[]
  portalDocuments   PortalDocument[]
  systemAlerts      SystemAlert[]
  deliverySchedules DeliverySchedule[]

  @@index([customerId])
  @@index([isActive])
}

model Lot {
  id          String @id @default(uuid())
  communityId String
  lotNumber   String

  // Status
  status LotStatus @default(AVAILABLE)

  // Lot Characteristics
  sqft     Int?
  frontage Decimal? @db.Decimal(10, 2)
  depth    Decimal? @db.Decimal(10, 2)

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  jobs      Job[]

  @@unique([communityId, lotNumber])
  @@index([communityId])
  @@index([status])
}

enum LotStatus {
  AVAILABLE
  RESERVED
  SOLD
  IN_PROGRESS
  COMPLETED
}

// ============================================================================
// OPERATIONAL CORE: JOB MANAGEMENT
// ============================================================================

model Job {
  id        String @id @default(uuid())
  jobNumber String @unique // Auto-generated or manual

  // Core References
  customerId  String
  planId      String
  elevationId String?
  communityId String?
  lotId       String?

  // Job Details
  status JobStatus @default(DRAFT)

  // Pricing
  estimatedCost Decimal? @db.Decimal(10, 2)
  actualCost    Decimal? @db.Decimal(10, 2)
  margin        Decimal? @db.Decimal(5, 2)

  // Workflow
  createdById    String
  approvedById   String?
  approvedAt     DateTime?
  startDate      DateTime?
  completionDate DateTime?

  // Documentation
  notes      String? @db.Text
  folderPath String? // Document storage path

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  customer   Customer       @relation(fields: [customerId], references: [id])
  plan       Plan           @relation(fields: [planId], references: [id])
  elevation  PlanElevation? @relation(fields: [elevationId], references: [id])
  community  Community?     @relation(fields: [communityId], references: [id])
  lot        Lot?           @relation(fields: [lotId], references: [id])
  createdBy  User           @relation("JobCreator", fields: [createdById], references: [id])
  approvedBy User?          @relation("JobApprover", fields: [approvedById], references: [id])

  jobOptions     JobOption[]
  takeoff        Takeoff?
  purchaseOrders PurchaseOrder[]
  pdssStatus     PDSSJobStatus? // PDSS tracking for this job

  @@index([jobNumber])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

enum JobStatus {
  DRAFT
  PENDING_APPROVAL
  ESTIMATED
  APPROVED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model JobOption {
  id       String @id @default(uuid())
  jobId    String
  optionId String

  quantity Int     @default(1)
  price    Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  job    Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  option PlanOption @relation(fields: [optionId], references: [id])

  @@unique([jobId, optionId])
  @@index([jobId])
}

// ============================================================================
// OPERATIONAL CORE: TAKEOFFS & VALIDATION
// ============================================================================

model Takeoff {
  id    String @id @default(uuid())
  jobId String @unique

  // Status
  status TakeoffStatus @default(DRAFT)

  // Validation
  isValidated       Boolean   @default(false)
  validatedAt       DateTime?
  validationResults Json? // Validation report

  // Totals
  totalEstimated Decimal  @db.Decimal(10, 2)
  totalActual    Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job        Job                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  lineItems  TakeoffLineItem[]
  validation TakeoffValidation?

  @@index([jobId])
  @@index([status])
}

enum TakeoffStatus {
  DRAFT
  IN_REVIEW
  VALIDATED
  APPROVED
  ORDERED
  DELIVERED
}

model TakeoffLineItem {
  id         String @id @default(uuid())
  takeoffId  String
  materialId String

  // Quantities
  quantityEstimated Decimal  @db.Decimal(10, 3)
  quantityActual    Decimal? @db.Decimal(10, 3)
  unit              String

  // Pricing
  unitPrice      Decimal  @db.Decimal(10, 2)
  totalEstimated Decimal  @db.Decimal(10, 2)
  totalActual    Decimal? @db.Decimal(10, 2)

  // Variance Tracking (FEEDBACK LOOP HOOK)
  variance        Decimal? @db.Decimal(10, 3) // quantityActual - quantityEstimated
  variancePercent Decimal? @db.Decimal(5, 2) // (variance / quantityEstimated) * 100
  varianceReason  String? // "Complex roof cuts", "Wet lumber replacement"

  // Categorization
  category    String
  subcategory String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  takeoff  Takeoff  @relation(fields: [takeoffId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id])

  @@index([takeoffId])
  @@index([materialId])
}

model TakeoffValidation {
  id        String @id @default(uuid())
  takeoffId String @unique

  // Multi-stage validation flags
  specCompliant      Boolean @default(false)
  pricingCurrent     Boolean @default(false)
  varianceAcceptable Boolean @default(false)

  // Validation Results
  issues   Json // Array of validation issues
  warnings Json // Array of warnings

  // Historical Comparison
  comparedToJobs String[] // Array of similar job IDs used for comparison
  avgVariance    Decimal? @db.Decimal(5, 2)

  validatedAt DateTime @default(now())

  takeoff Takeoff @relation(fields: [takeoffId], references: [id], onDelete: Cascade)

  @@index([takeoffId])
}

// ============================================================================
// TRANSACTION LAYER: PURCHASE ORDERS
// ============================================================================

model PurchaseOrder {
  id       String  @id @default(uuid())
  poNumber String  @unique
  jobId    String
  vendorId String?

  // Status
  status POStatus @default(DRAFT)

  // Amounts
  totalAmount Decimal @db.Decimal(10, 2)

  // Workflow
  approvedAt  DateTime?
  sentAt      DateTime?
  confirmedAt DateTime?
  deliveredAt DateTime?

  // Delivery
  scheduledDelivery DateTime?
  actualDelivery    DateTime?
  deliveryNotes     String?

  // External System Integration
  hyphenBuildProId String?
  holtPortalId     String?

  // Documentation
  signatureUrl String?
  photoUrls    String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job    Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  vendor Vendor? @relation(fields: [vendorId], references: [id])

  @@index([poNumber])
  @@index([jobId])
  @@index([status])
  @@index([scheduledDelivery])
}

enum POStatus {
  DRAFT
  APPROVED
  SENT
  CONFIRMED
  DELIVERED
  CANCELLED
}

// ============================================================================
// INTELLIGENCE LAYER: VARIANCE & LEARNING
// ============================================================================

model VariancePattern {
  id String @id @default(uuid())

  // Pattern Scope (Hierarchical Learning)
  scope       VarianceScope
  planId      String?
  communityId String?
  customerId  String?
  region      String?

  // Material & Category
  materialCategory String
  subcategory      String?

  // Statistical Data
  sampleSize      Int
  avgVariance     Decimal @db.Decimal(5, 2)
  stdDeviation    Decimal @db.Decimal(5, 2)
  confidenceScore Decimal @db.Decimal(3, 2) // 0-1

  // Recommendation
  recommendedAdjustment Decimal? @db.Decimal(5, 2)
  reasoning             String?  @db.Text

  // Status
  status     PatternStatus @default(DETECTED)
  reviewedAt DateTime?
  appliedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plan      Plan?            @relation(fields: [planId], references: [id])
  community Community?       @relation(fields: [communityId], references: [id])
  customer  Customer?        @relation(fields: [customerId], references: [id])
  reviews   VarianceReview[]

  @@index([scope])
  @@index([planId])
  @@index([status])
  @@index([confidenceScore])
}

enum VarianceScope {
  PLAN_SPECIFIC // Single plan (Phase 1)
  CROSS_PLAN // Pattern across plans
  COMMUNITY // Community-level
  BUILDER // Builder-level
  REGIONAL // Regional patterns
}

enum PatternStatus {
  DETECTED // System detected pattern
  UNDER_REVIEW // Flagged for human review
  APPROVED // Approved for auto-application
  APPLIED // Applied to templates
  REJECTED // Rejected by reviewer
}

model VarianceReview {
  id         String @id @default(uuid())
  patternId  String
  reviewerId String

  decision ReviewDecision
  notes    String?        @db.Text

  reviewedAt DateTime @default(now())

  pattern  VariancePattern @relation(fields: [patternId], references: [id], onDelete: Cascade)
  reviewer User            @relation(fields: [reviewerId], references: [id])

  @@index([patternId])
  @@index([reviewerId])
}

enum ReviewDecision {
  APPROVE
  REJECT
  NEEDS_MORE_DATA
  ESCALATE
}

// ============================================================================
// INTELLIGENCE LAYER: COMMUNICATIONS & NOTIFICATIONS
// ============================================================================

model Notification {
  id     String @id @default(uuid())
  userId String

  // Notification Content
  type    NotificationType
  title   String
  message String           @db.Text

  // Action
  actionUrl String?

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  JOB_CREATED
  JOB_APPROVED
  PO_APPROVED
  DELIVERY_SCHEDULED
  DELIVERY_LATE
  VARIANCE_DETECTED
  PATTERN_REVIEW_REQUIRED
  SYSTEM_ALERT
}

// ============================================================================
// SYSTEM: AUDIT LOGGING
// ============================================================================

model AuditLog {
  id     String  @id @default(uuid())
  userId String?

  // Action
  action     String // "CREATE_JOB", "UPDATE_MATERIAL", "APPROVE_PO"
  entityType String // "Job", "Material", "PurchaseOrder"
  entityId   String

  // Changes
  changes Json // Before/after snapshot

  // Context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================================================
// PORTAL SYNC & DASHBOARD (Python Agent Integration)
// ============================================================================
// These models support integration with STO Python agents for portal syncing,
// alerts, activity tracking, and delivery scheduling.

model PortalOrder {
  id          String    @id @default(uuid())
  externalId  String    @unique @map("external_id") // PO number from SupplyPro/Hyphen
  portal      String // "supplypro", "hyphen"
  orderType   String    @map("order_type") // "po", "bid", "epo"
  category    String? // "Lumber", "Trusses", "Siding", etc.
  status      String // "pending", "approved", "delivered", "late"
  amount      Decimal   @db.Decimal(12, 2)
  description String?
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")

  // Relations to existing models
  customerId  String?    @map("customer_id")
  customer    Customer?  @relation(fields: [customerId], references: [id])
  communityId String?    @map("community_id")
  community   Community? @relation(fields: [communityId], references: [id])
  lotNumber   Int?       @map("lot_number")

  // Metadata
  rawData   Json?    @map("raw_data") // Full response from portal
  syncedAt  DateTime @default(now()) @map("synced_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([portal, orderType])
  @@index([status])
  @@index([dueDate])
  @@map("portal_orders")
}

model PortalDocument {
  id         String  @id @default(uuid())
  externalId String? @map("external_id") // ID from source system
  portal     String // "supplypro", "hyphen", "onedrive"
  filename   String
  docType    String? @map("doc_type") // "ARCH_DRAWINGS", "CALC_PKG", "TRUSS_CALCS"
  fileUrl    String? @map("file_url") // URL or path to document
  fileSize   Int?    @map("file_size")

  // Relations
  customerId  String?    @map("customer_id")
  customer    Customer?  @relation(fields: [customerId], references: [id])
  communityId String?    @map("community_id")
  community   Community? @relation(fields: [communityId], references: [id])
  planId      String?    @map("plan_id")
  plan        Plan?      @relation(fields: [planId], references: [id])
  lotNumber   Int?       @map("lot_number")

  status      String    @default("received") // received, processed, archived
  processedAt DateTime? @map("processed_at")
  syncedAt    DateTime  @default(now()) @map("synced_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([portal, docType])
  @@index([customerId])
  @@map("portal_documents")
}

model SystemAlert {
  id        String  @id @default(uuid())
  alertType String  @map("alert_type") // "critical", "warning", "info"
  source    String // "portal_sync", "completeness_check", "variance"
  title     String
  message   String
  details   Json?
  actionUrl String? @map("action_url")

  // Relations
  customerId  String?    @map("customer_id")
  customer    Customer?  @relation(fields: [customerId], references: [id])
  communityId String?    @map("community_id")
  community   Community? @relation(fields: [communityId], references: [id])
  orderId     String?    @map("order_id")

  isRead      Boolean   @default(false) @map("is_read")
  isDismissed Boolean   @default(false) @map("is_dismissed")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([alertType, isDismissed])
  @@index([createdAt])
  @@map("system_alerts")
}

model ActivityLog {
  id           String   @id @default(uuid())
  activityType String   @map("activity_type") // "po_approved", "bid_submitted", "delivery", "document"
  title        String
  detail       String?
  amount       Decimal? @db.Decimal(12, 2)
  icon         String?

  // Relations
  userId     String?   @map("user_id")
  user       User?     @relation(fields: [userId], references: [id])
  customerId String?   @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])
  orderId    String?   @map("order_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([activityType])
  @@index([createdAt])
  @@map("activity_logs")
}

model DeliverySchedule {
  id            String   @id @default(uuid())
  portal        String // "supplypro", "hyphen"
  orderId       String?  @map("order_id")
  scheduledTime DateTime @map("scheduled_time")
  title         String
  location      String?
  status        String   @default("scheduled") // scheduled, in_transit, delivered

  // Relations
  communityId String?    @map("community_id")
  community   Community? @relation(fields: [communityId], references: [id])
  lotNumber   Int?       @map("lot_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([scheduledTime])
  @@index([status])
  @@map("delivery_schedules")
}

model PortalSyncLog {
  id             String    @id @default(uuid())
  portal         String
  syncType       String    @map("sync_type") // "orders", "documents", "deliveries"
  status         String // "started", "completed", "failed"
  itemsFound     Int       @default(0) @map("items_found")
  itemsProcessed Int       @default(0) @map("items_processed")
  errors         Json?
  startedAt      DateTime  @default(now()) @map("started_at")
  completedAt    DateTime? @map("completed_at")

  @@index([portal, syncType])
  @@index([startedAt])
  @@map("portal_sync_logs")
}

// ============================================================================
// PDSS (PLAN DATA STATUS SHEET) TRACKING
// ============================================================================
// Tracks plan/elevation document status and job-level PDSS completion.
// Based on STO PDSS workflow: Plan status, takeoff status, quote status.

// Builder-specific required documents definition
model PDSSDocumentRequirement {
  id         String   @id @default(uuid())
  customerId String   @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id])

  docType     String  @map("doc_type") // "ARCH_DRAWINGS", "STRUCT_CALCS", "TRUSS_LAYOUT", etc.
  docName     String  @map("doc_name") // Human readable name
  isRequired  Boolean @default(true) @map("is_required")
  description String?

  // Timing requirements
  requiredByPhase String? @map("required_by_phase") // "BEFORE_START", "FRAMING", "PRE_DRYWALL"
  daysBeforeStart Int?    @map("days_before_start") // Days before job start this is needed

  sortOrder Int     @default(0) @map("sort_order")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  documentStatuses PDSSDocumentStatus[]

  @@unique([customerId, docType])
  @@index([customerId])
  @@map("pdss_document_requirements")
}

// Plan/Elevation level PDSS status
model PDSSPlanStatus {
  id String @id @default(uuid())

  // Link to plan and optionally elevation
  planId      String         @map("plan_id")
  plan        Plan           @relation(fields: [planId], references: [id])
  elevationId String?        @map("elevation_id")
  elevation   PlanElevation? @relation(fields: [elevationId], references: [id])

  // Status tracking
  planStatus    PDSSStatus        @default(NEW) @map("plan_status")
  takeoffStatus PDSSTakeoffStatus @default(NOT_STARTED) @map("takeoff_status")
  quoteStatus   PDSSQuoteStatus   @default(NOT_STARTED) @map("quote_status")

  // Document completeness
  documentsComplete Boolean @default(false) @map("documents_complete")
  documentCount     Int     @default(0) @map("document_count")

  // Assignment & Priority
  assignedToId String?      @map("assigned_to_id")
  assignedTo   User?        @relation(fields: [assignedToId], references: [id])
  priority     PDSSPriority @default(MEDIUM)
  dueDate      DateTime?    @map("due_date")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  documentStatuses PDSSDocumentStatus[]

  @@unique([planId, elevationId])
  @@index([planId])
  @@index([planStatus])
  @@index([assignedToId])
  @@map("pdss_plan_status")
}

// Job-level PDSS status (per lot implementation)
model PDSSJobStatus {
  id String @id @default(uuid())

  // Link to job
  jobId String @unique @map("job_id")
  job   Job    @relation(fields: [jobId], references: [id])

  // Status tracking (inherits from plan but can override)
  planStatus    PDSSStatus        @default(NEW) @map("plan_status")
  takeoffStatus PDSSTakeoffStatus @default(NOT_STARTED) @map("takeoff_status")
  quoteStatus   PDSSQuoteStatus   @default(NOT_STARTED) @map("quote_status")

  // Document completeness for this specific job
  documentsComplete Boolean @default(false) @map("documents_complete")
  missingDocuments  Json?   @map("missing_documents") // Array of missing doc types

  // Assignment & Priority
  assignedToId String?      @map("assigned_to_id")
  assignedTo   User?        @relation(fields: [assignedToId], references: [id])
  priority     PDSSPriority @default(MEDIUM)
  dueDate      DateTime?    @map("due_date")

  // Alerts
  alertsSent  Int       @default(0) @map("alerts_sent")
  lastAlertAt DateTime? @map("last_alert_at")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([jobId])
  @@index([planStatus])
  @@index([priority])
  @@map("pdss_job_status")
}

// Individual document status tracking
model PDSSDocumentStatus {
  id String @id @default(uuid())

  // Link to requirement
  requirementId String                  @map("requirement_id")
  requirement   PDSSDocumentRequirement @relation(fields: [requirementId], references: [id])

  // Link to plan status (optional - for plan-level tracking)
  planStatusId String?         @map("plan_status_id")
  planStatus   PDSSPlanStatus? @relation(fields: [planStatusId], references: [id])

  // Status
  status       DocumentReceiptStatus @default(PENDING)
  receivedAt   DateTime?             @map("received_at")
  verifiedAt   DateTime?             @map("verified_at")
  verifiedById String?               @map("verified_by_id")

  // Document reference
  documentUrl     String? @map("document_url")
  documentVersion Int     @default(1) @map("document_version")

  // Notes
  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([requirementId, planStatusId])
  @@index([requirementId])
  @@index([planStatusId])
  @@index([status])
  @@map("pdss_document_status")
}

enum PDSSStatus {
  NEW
  IN_PROGRESS
  COMPLETE
  ON_HOLD
  ARCHIVED
}

enum PDSSTakeoffStatus {
  NOT_STARTED
  IN_PROGRESS
  PENDING_REVIEW
  COMPLETE
}

enum PDSSQuoteStatus {
  NOT_STARTED
  DRAFT
  SENT
  APPROVED
  REJECTED
}

enum PDSSPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum DocumentReceiptStatus {
  PENDING
  RECEIVED
  VERIFIED
  REJECTED
  SUPERSEDED
}

// ============================================================================
// UNIFIED CODE SYSTEM
// ============================================================================
// Two-layer hierarchical code system for construction material management
// Layer 1: Aggregate codes for estimating/quoting (Plan-Phase/Option-MaterialClass)
// Layer 2: Detailed material SKUs for purchasing/inventory
// Source: Coding_Schema_v2_NEW_FORMAT.csv

// Material Class Definitions (high-level categories)
model MaterialClass {
  id          String  @id @default(uuid())
  classCode   String  @unique @map("class_code") // "1000", "1100"
  className   String  @map("class_name") // "Framing", "Siding"
  description String?
  sortOrder   Int?    @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  phaseOptions  PhaseOptionDefinition[]
  layer1Codes   Layer1Code[]
  itemTypeXrefs ItemTypeXref[]

  @@index([classCode])
  @@map("material_classes")
}

// Phase and Option Code Definitions
model PhaseOptionDefinition {
  id        String @id @default(uuid())
  phaseCode String @unique @map("phase_code") // "10.00", "20.rf", "60.ec"
  phaseName String @map("phase_name")

  // Phase Classification
  isBasePhase    Boolean @default(false) @map("is_base_phase")
  isOption       Boolean @default(true) @map("is_option")
  isAlphaVariant Boolean @default(false) @map("is_alpha_variant") // Uses letter suffix (rf, tc, etc.)

  // Material Class Reference
  materialClassId String @map("material_class_id")

  // Shipping/Construction Order
  shippingOrder Int? @map("shipping_order")

  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  materialClass   MaterialClass        @relation(fields: [materialClassId], references: [id])
  layer1Codes     Layer1Code[]
  richmondOptions RichmondOptionCode[]
  holtPhaseXrefs  HoltPhaseXref[]

  @@index([phaseCode])
  @@index([materialClassId])
  @@index([shippingOrder])
  @@map("phase_option_definitions")
}

// Richmond Option Code Mappings
// Maps Richmond builder's mnemonic codes to phase codes
model RichmondOptionCode {
  id                String  @id @default(uuid())
  optionCode        String  @unique @map("option_code") // "XGREAT", "SUN", "TALLCRWL"
  optionDescription String? @map("option_description")

  // Link to phase (optional for multi-phase options)
  phaseId      String? @map("phase_id")
  isMultiPhase Boolean @default(false) @map("is_multi_phase")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  phase             PhaseOptionDefinition?     @relation(fields: [phaseId], references: [id])
  layer1CodeOptions Layer1CodeRichmondOption[]

  @@index([optionCode])
  @@map("richmond_option_codes")
}

// Layer 1: Aggregate Codes for Estimating
// Format: PLAN-PHASE/OPTION-ELEVATION-MATERIALCLASS (e.g., "PPPP-020.000-ABC-1000")
model Layer1Code {
  id String @id @default(uuid())

  // Code Components
  planCode        String @map("plan_code") // "PPPP" (placeholder) or actual plan code
  phaseOptionId   String @map("phase_option_id")
  materialClassId String @map("material_class_id")

  // Full Generated Code (for display/lookup)
  fullCode String @unique @map("full_code") // "PPPP-020.000-**-1000"

  // Original Richmond Pack ID (for reference)
  richmondPackId String? @map("richmond_pack_id")
  packName       String? @map("pack_name")

  // Item Information
  itemNo   String? @map("item_no") // "1000", "1100"
  itemType String? @map("item_type") // "Framing", "Siding"

  // Shipping Order
  shippingOrder Int? @map("shipping_order")

  description String?

  // Pricing (for estimating)
  estimatedPrice Decimal? @map("estimated_price") @db.Decimal(10, 2)
  estimatedCost  Decimal? @map("estimated_cost") @db.Decimal(10, 2)

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  phaseOption   PhaseOptionDefinition @relation(fields: [phaseOptionId], references: [id])
  materialClass MaterialClass         @relation(fields: [materialClassId], references: [id])

  // Many-to-many: Elevations and Richmond Options
  elevations      Layer1CodeElevation[]
  richmondOptions Layer1CodeRichmondOption[]
  layer2Materials Layer2Material[]

  @@index([fullCode])
  @@index([planCode])
  @@index([phaseOptionId])
  @@index([materialClassId])
  @@index([richmondPackId])
  @@map("layer1_codes")
}

// Layer 1 Code Elevation Associations
// Solves Richmond's triple-encoding problem: single source of truth for elevations
model Layer1CodeElevation {
  id            String @id @default(uuid())
  layer1CodeId  String @map("layer1_code_id")
  elevationCode String @map("elevation_code") // "A", "B", "C", "D", or "**" for all

  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  layer1Code Layer1Code @relation(fields: [layer1CodeId], references: [id], onDelete: Cascade)

  @@unique([layer1CodeId, elevationCode])
  @@index([layer1CodeId])
  @@index([elevationCode])
  @@map("layer1_code_elevations")
}

// Layer 1 Code Richmond Option Associations
// Links Richmond option codes to Layer 1 codes for cross-referencing
model Layer1CodeRichmondOption {
  id               String @id @default(uuid())
  layer1CodeId     String @map("layer1_code_id")
  richmondOptionId String @map("richmond_option_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  layer1Code     Layer1Code         @relation(fields: [layer1CodeId], references: [id], onDelete: Cascade)
  richmondOption RichmondOptionCode @relation(fields: [richmondOptionId], references: [id], onDelete: Cascade)

  @@unique([layer1CodeId, richmondOptionId])
  @@index([layer1CodeId])
  @@index([richmondOptionId])
  @@map("layer1_code_richmond_options")
}

// Layer 2: Detailed Materials (SKU-level)
// Links to existing Material model for purchasing and inventory
model Layer2Material {
  id           String @id @default(uuid())
  layer1CodeId String @map("layer1_code_id")

  // Item Details
  itemCode        String  @map("item_code")
  itemDescription String? @map("item_description")

  // Quantity and Units
  quantity Decimal @default(0) @db.Decimal(10, 3)
  unit     String

  // Costing
  unitCost Decimal? @map("unit_cost") @db.Decimal(10, 2)

  // Vendor Information
  vendorCode             String? @map("vendor_code")
  manufacturerPartNumber String? @map("manufacturer_part_number")

  // Link to main Material catalog (optional)
  materialId String? @map("material_id")

  notes    String?
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  layer1Code Layer1Code @relation(fields: [layer1CodeId], references: [id], onDelete: Cascade)

  @@unique([layer1CodeId, itemCode])
  @@index([layer1CodeId])
  @@index([itemCode])
  @@index([materialId])
  @@map("layer2_materials")
}

// Option Suffix Definitions
// Defines the .x01, .x02, etc. suffixes for option codes
model OptionSuffix {
  id           String  @id @default(uuid())
  suffixCode   String  @unique @map("suffix_code") // "01", "03", "04", etc.
  abbreviation String // "rf", "l", "nl", "x", etc.
  fullName     String  @map("full_name") // "ReadyFrame", "Loft", etc.
  description  String?

  // Category for grouping
  category String? // "structural", "exterior", etc.

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([suffixCode])
  @@index([abbreviation])
  @@map("option_suffixes")
}

// ============================================================================
// HOLT CROSS-REFERENCE SYSTEM
// Maps Holt's 5-digit phase codes to unified phase system
// ============================================================================

// Holt Phase Cross-Reference
// Maps Holt's OptionPhase (10100, 10200, 40100) to unified phases (010.000, 020.000)
model HoltPhaseXref {
  id String @id @default(uuid())

  // Holt Source Data
  holtPhaseCode   String  @unique @map("holt_phase_code") // "10100", "10200", "40100"
  holtCostCode    String? @map("holt_cost_code") // "4085", "4120", "4155"
  holtDescription String? @map("holt_description")

  // Unified System Mapping
  unifiedPhaseId String?                @map("unified_phase_id")
  unifiedPhase   PhaseOptionDefinition? @relation(fields: [unifiedPhaseId], references: [id])

  // Elevation extraction (from Holt's pattern)
  // Holt uses: 10100=A, 10200=B, 10300=C, 10400=D
  elevationCode String? @map("elevation_code") // "A", "B", "C", "D", "**"

  // Item Type mapping
  itemTypeCode String? @map("item_type_code") // "1000", "1100" (unified)

  // BAT Pack association (for shipping order)
  batPackId     String? @map("bat_pack_id") // "|10", "|20", "|22"
  shippingOrder Int?    @map("shipping_order")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([holtPhaseCode])
  @@index([holtCostCode])
  @@index([unifiedPhaseId])
  @@index([batPackId])
  @@map("holt_phase_xref")
}

// Item Type Cross-Reference
// Maps Holt cost codes to unified material classes
model ItemTypeXref {
  id String @id @default(uuid())

  // Holt Cost Code
  holtCostCode String  @unique @map("holt_cost_code") // "4085", "4086", "4120"
  holtCostName String? @map("holt_cost_name") // "Lumber", "Trusses"

  // Unified Material Class
  materialClassId String?        @map("material_class_id")
  materialClass   MaterialClass? @relation(fields: [materialClassId], references: [id])

  // DART Category (if applicable)
  dartCategory     Int?    @map("dart_category")
  dartCategoryName String? @map("dart_category_name")

  description String?
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([holtCostCode])
  @@index([materialClassId])
  @@map("item_type_xref")
}

// BAT Pack Definition
// Legacy BAT pack structure for shipping order and Richmond code grouping
model BatPackDefinition {
  id String @id @default(uuid())

  packId    String  @unique @map("pack_id") // "|10", "|20", "|22"
  packName  String  @map("pack_name") // "Foundation", "Main Walls"
  packTitle String? @map("pack_title") // Legacy BAT title

  // Richmond codes associated with this pack (comma-separated for legacy)
  richmondCodes String? @map("richmond_codes") // "ELVA,ELVB,ELVC"

  // Shipping information
  shippingOrder Int     @map("shipping_order")
  shipsWith     String? @map("ships_with") // Other packs that ship together

  // Material class default
  materialClassId String? @map("material_class_id")

  description String?
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([packId])
  @@index([shippingOrder])
  @@map("bat_pack_definitions")
}

// ============================================================================
// FEEDBACK & LEARNING SYSTEM
// ============================================================================
// Captures feedback for continuous improvement of estimates, processes, and data quality

enum FeedbackType {
  VARIANCE_REPORT // Estimate vs Actual comparison
  QUALITY_ISSUE // Data quality problem identified
  PROCESS_FAILURE // Agent/automation failure
  SUGGESTION // User improvement suggestion
  CORRECTION // User corrected auto-generated data
  THUMBS_UP // Quick positive feedback
  THUMBS_DOWN // Quick negative feedback
}

enum FeedbackCategory {
  MATERIAL // Material quantity/cost variance
  TIMING // Schedule/timing variance
  DOCUMENT // Document quality/completeness
  ESTIMATE // Estimate accuracy
  IMPORT // Data import quality
  AGENT // Python agent performance
  UI_UX // User interface feedback
  OTHER // Miscellaneous
}

enum FeedbackStatus {
  NEW // Just submitted
  REVIEWED // Looked at by admin
  IN_PROGRESS // Being addressed
  RESOLVED // Fixed/implemented
  DISMISSED // Not actionable
  DEFERRED // Will address later
}

// Main Feedback entries
model Feedback {
  id           String           @id @default(uuid())
  feedbackType FeedbackType     @map("feedback_type")
  category     FeedbackCategory @default(OTHER)

  // Entity being rated/reviewed
  entityType String  @map("entity_type") // Job, Plan, Estimate, Agent, Import
  entityId   String  @map("entity_id")
  entityName String? @map("entity_name") // Human-readable reference

  // Quick feedback
  rating Int? // 1-5 star rating or -1/+1 for thumbs

  // Variance tracking (for estimates)
  estimatedValue  Decimal? @map("estimated_value") @db.Decimal(12, 2)
  actualValue     Decimal? @map("actual_value") @db.Decimal(12, 2)
  varianceAmount  Decimal? @map("variance_amount") @db.Decimal(12, 2)
  variancePercent Decimal? @map("variance_percent") @db.Decimal(5, 2)

  // Details
  title       String?
  description String? @db.Text
  notes       String? @db.Text

  // Context
  context Json? // Additional structured data
  tags    String[] @default([])

  // Source tracking
  source        String? // "web", "agent", "import", "manual"
  submittedById String? @map("submitted_by_id")
  submittedBy   User?   @relation("FeedbackSubmitter", fields: [submittedById], references: [id])

  // Resolution tracking
  status       FeedbackStatus @default(NEW)
  resolvedById String?        @map("resolved_by_id")
  resolvedBy   User?          @relation("FeedbackResolver", fields: [resolvedById], references: [id])
  resolvedAt   DateTime?      @map("resolved_at")
  actionTaken  String?        @map("action_taken") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  responses FeedbackResponse[]
  patterns  FeedbackPattern[]  @relation("PatternFeedback")

  @@index([feedbackType])
  @@index([category])
  @@index([entityType, entityId])
  @@index([status])
  @@index([submittedById])
  @@index([createdAt])
  @@map("feedback")
}

// Feedback responses/comments
model FeedbackResponse {
  id         String   @id @default(uuid())
  feedbackId String   @map("feedback_id")
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  responderId String @map("responder_id")
  responder   User   @relation(fields: [responderId], references: [id])

  message    String  @db.Text
  isInternal Boolean @default(false) @map("is_internal") // Internal team notes

  createdAt DateTime @default(now()) @map("created_at")

  @@index([feedbackId])
  @@index([responderId])
  @@map("feedback_responses")
}

// Detected patterns from feedback analysis
model FeedbackPattern {
  id String @id @default(uuid())

  // Pattern identification
  patternType String  @map("pattern_type") // "over_estimate", "under_estimate", "missing_doc"
  patternName String  @map("pattern_name")
  description String? @db.Text

  // Pattern scope
  entityType String? @map("entity_type") // Plan, Builder, MaterialClass, etc.
  entityId   String? @map("entity_id")
  entityName String? @map("entity_name")

  // Statistics
  occurrenceCount Int      @default(0) @map("occurrence_count")
  avgVariance     Decimal? @map("avg_variance") @db.Decimal(12, 2)
  avgVariancePct  Decimal? @map("avg_variance_pct") @db.Decimal(5, 2)
  totalImpact     Decimal? @map("total_impact") @db.Decimal(12, 2)

  // Confidence
  confidence Decimal? @db.Decimal(3, 2) // 0.00 to 1.00
  sampleSize Int      @default(0) @map("sample_size")

  // Recommended action
  recommendation   String?  @db.Text
  adjustmentFactor Decimal? @map("adjustment_factor") @db.Decimal(5, 4) // e.g., 1.05 for 5% increase

  // Status
  isActive    Boolean   @default(true) @map("is_active")
  isApplied   Boolean   @default(false) @map("is_applied") // Has adjustment been applied?
  appliedAt   DateTime? @map("applied_at")
  appliedById String?   @map("applied_by_id")

  // Analysis metadata
  lastAnalyzedAt DateTime? @map("last_analyzed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Related feedback items that formed this pattern
  feedbackItems Feedback[] @relation("PatternFeedback")

  @@index([patternType])
  @@index([entityType, entityId])
  @@index([isActive])
  @@map("feedback_patterns")
}

// Variance tracking summary (aggregate stats)
model VarianceSummary {
  id String @id @default(uuid())

  // Period
  periodType  String   @map("period_type") // "daily", "weekly", "monthly"
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  // Scope
  entityType String  @map("entity_type") // "all", "builder", "plan", "material_class"
  entityId   String? @map("entity_id")
  entityName String? @map("entity_name")

  // Aggregate statistics
  totalEstimated  Decimal @map("total_estimated") @db.Decimal(14, 2)
  totalActual     Decimal @map("total_actual") @db.Decimal(14, 2)
  totalVariance   Decimal @map("total_variance") @db.Decimal(14, 2)
  variancePercent Decimal @map("variance_percent") @db.Decimal(5, 2)

  // Counts
  jobCount       Int @map("job_count")
  overEstimates  Int @default(0) @map("over_estimates")
  underEstimates Int @default(0) @map("under_estimates")
  onTarget       Int @default(0) @map("on_target") // Within threshold

  // Distribution
  avgVariance    Decimal? @map("avg_variance") @db.Decimal(12, 2)
  medianVariance Decimal? @map("median_variance") @db.Decimal(12, 2)
  stdDevVariance Decimal? @map("std_dev_variance") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([periodType, periodStart, entityType, entityId])
  @@index([periodType, periodStart])
  @@index([entityType, entityId])
  @@map("variance_summaries")
}
